import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,f as i,o as e}from"./app-BKo-uRzl.js";const p={};function l(r,n){return e(),a("div",null,n[0]||(n[0]=[i(`<h1 id="nginx优化" tabindex="-1"><a class="header-anchor" href="#nginx优化"><span>Nginx优化</span></a></h1><h2 id="cpu亲和" tabindex="-1"><a class="header-anchor" href="#cpu亲和"><span>CPU亲和</span></a></h2><h3 id="worker-cpu-affinity的指令介绍" tabindex="-1"><a class="header-anchor" href="#worker-cpu-affinity的指令介绍"><span>worker_cpu_affinity的指令介绍</span></a></h3><p>Nginx提供了一种名为worker_cpu_affinity的指令，可以让你指定Nginxworker进程与特定CPU核心之间的亲和性，也就是把某个或某些worker进程<br> 绑定到具体的CPU 核心上运行。通过设置CPU亲和性，你可I以提高Nginx的性能，因为当进程始终在同一个CPU 核心上执行时，可I以利用CPU的缓存，<br> 从而减少内存访问延迟。<br> 下面是一些用法示例：</p><p>1、绑定每一个 worker进程到一个具体的 CPU 核心:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># 示例1、如果有个4核</span></span>
<span class="line"><span>worker_processes  4;</span></span>
<span class="line"><span>worker_cpu_affinity 0001 0010 0100 1000; # 4个核心，就用4位bit，哪一位为1则代表用第几颗</span></span>
<span class="line"><span>===</span></span>
<span class="line"><span># 示例2、如果有16核</span></span>
<span class="line"><span>worker_processes    16;</span></span>
<span class="line"><span>worker_cpu_affinity 0000000000000001 0000000000000010 0000000000000100 0000000000001000 ...;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述示例1中，worker_processes表示总共有4个worker进程，每行的worker_cpu_affinity分别对应一个二进制数，用来表示该worker进程应被<br> 绑定到哪个CPU核心上。这种配置方式在你精确知道服务器有多少CPU核心，并且希望将进程直接绑定到特定核心上时非常有用。</p><p>2、自动分配worker进程到所有可用的CPU核心：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>worker_processes  auto;</span></span>
<span class="line"><span>worker_cpu_affinity auto;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>以上配置将会自动检测你的机器有多少个CPU核心，并尝试将每个worker进程绑定到一个独立的CPU核心上。这种配置方式在你不确定服务器具体<br> 有多少CPU核心，或者不希望手动指定进程绑定的核心时非常有用。<br> 设置 CPU 亲和性后，worker 进程在运行时将始终在同一个 CPU 核心上执行，从而更有效地利用 CPU 的缓存，减少内存访问延迟，提高整体性能。<br> 但也需要注意，如果服务器同时运行着其他CPU密集型任务，设置CPU亲和性可能并不能产生显著的性能提升，甚至可能会降低性能，因为这可能导<br> 致 CPU 核心的过度使用。<br> 在实际应用中，你可能需要根据你的服务器的特定情况进行调整和优化。</p><h3 id="案例" tabindex="-1"><a class="header-anchor" href="#案例"><span>案例</span></a></h3><p>查看当没有指定cpu的时候，每个worker进程都跑在哪些cpu上</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>[root@lb ~]# cat /etc/nginx/nginx.conf |grep -i work</span></span>
<span class="line"><span>worker_processes 2;</span></span>
<span class="line"><span>[root@lb ~]#  ps -eo pid,args,psr | grep [n]ginx</span></span>
<span class="line"><span>   6989 nginx: master process /usr/   1</span></span>
<span class="line"><span>   6990 nginx: worker process         0 # 第一颗</span></span>
<span class="line"><span>   6991 nginx: worker process         1 # 第二颗</span></span>
<span class="line"><span>补充说明：命令ps -eo pid,args,psr 是用来显示进程ID（pid）、命令行参数（args）以及进程运行的处理器ID（psr）。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="nginx通用优化文件" tabindex="-1"><a class="header-anchor" href="#nginx通用优化文件"><span>Nginx通用优化文件</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>[root@nginx ~]# cat nginx.conf</span></span>
<span class="line"><span>user www;                                   #nginx启动用户</span></span>
<span class="line"><span>worker_processes auto;                       #nginx工作进程数</span></span>
<span class="line"><span>worker_cpu_affinity auto;                     #开启CPU亲和</span></span>
<span class="line"><span>error_log /var/log/nginx/error.log warn;      #错误日志，存放路径，记录日志的级别</span></span>
<span class="line"><span>pid /run/nginx.pid;                         #指定pid文件位置</span></span>
<span class="line"><span>worker_rlimit_nofile 35535;                  #指定nginx服务的最大打开文件数</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>events {</span></span>
<span class="line"><span>    use epoll;                              #使用epoll网络模型</span></span>
<span class="line"><span>    worker_connections 10240;                #worker工作进程的最大连接数</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>http {</span></span>
<span class="line"><span>    include             mime.types;                #nginx能识别的文件类型</span></span>
<span class="line"><span>    default_type        application/octet-stream;   #nginx不识别的文件类型默认下载</span></span>
<span class="line"><span>    charset utf-8;                               #指定字符集</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line"><span>                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line"><span>                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;           #配置日志格式</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>    access_log  /var/log/nginx/access.log  main     #指定访问日志路径，调用日志的格式</span></span>
<span class="line"><span>    server_tokens off;                            #隐藏版本号</span></span>
<span class="line"><span>    client_max_body_size 200m;                     #上传文件大小限制</span></span>
<span class="line"><span>    sendfile            on;                        #高效读取</span></span>
<span class="line"><span>    tcp_nopush          on;                         #高效传输</span></span>
<span class="line"><span>    #tcp_nodelay         on;                        #实时传输</span></span>
<span class="line"><span>    keepalive_timeout   65;                         #开启长连接</span></span>
<span class="line"><span>    gzip on;                                      #开启压缩</span></span>
<span class="line"><span>    gzip_disable &quot;MSIE [1-6]\\.&quot;;                  #指定不压缩的浏览器</span></span>
<span class="line"><span>    gzip_http_version 1.1;                          #压缩后传输的协议</span></span>
<span class="line"><span>    gzip_comp_level 4;                              #压缩的级别</span></span>
<span class="line"><span>    gzip_buffers 16 8k;                             #压缩缓存</span></span>
<span class="line"><span>    gzip_min_length 1024;                           #开启压缩的最小值</span></span>
<span class="line"><span>    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript image/jpeg;       #压缩的文件类型</span></span>
<span class="line"><span>    include /etc/nginx/conf.d/*.conf;               #包含的配置文件</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="nginx优化总结" tabindex="-1"><a class="header-anchor" href="#nginx优化总结"><span>nginx优化总结</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>1、CPU亲和、worker进程数、调整nginx进程打开的文件句柄数</span></span>
<span class="line"><span>2、使用Epool网络模型、调整每个worker进程的最大连接数</span></span>
<span class="line"><span>3、文件的高效读取sendfile、nopush</span></span>
<span class="line"><span>4、文件的传输实时性、nodealy</span></span>
<span class="line"><span>5、开启tcp长连接，以及长连接超时时间keepalive_timeout</span></span>
<span class="line"><span>6、开启文件传输压缩gzip</span></span>
<span class="line"><span>7、开启静态文件expires缓存</span></span>
<span class="line"><span>8、隐藏nginx版本号</span></span>
<span class="line"><span>9、禁止通过ip地址访问，禁止恶意域名解析，只允许域名访问</span></span>
<span class="line"><span>10、配置防盗链、以及跨域访问</span></span>
<span class="line"><span>11、防DDOS、cc攻击，限制单IP并发连接，以及http请求</span></span>
<span class="line"><span>12、优雅显示nginx错误页面</span></span>
<span class="line"><span>13、nginx加密传输https优化</span></span>
<span class="line"><span>14、nginx proxy_cache、fastcgi_cache、uwsgi_cache 代理缓存，第三方工具（squid、varnish）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,17)]))}const t=s(p,[["render",l]]),o=JSON.parse('{"path":"/docs/optimization/nginx.html","title":"Nginx优化","lang":"zh-CN","frontmatter":{"date":"2020-07-05T00:00:00.000Z","category":["优化手段"],"description":"Nginx优化 CPU亲和 worker_cpu_affinity的指令介绍 Nginx提供了一种名为worker_cpu_affinity的指令，可以让你指定Nginxworker进程与特定CPU核心之间的亲和性，也就是把某个或某些worker进程 绑定到具体的CPU 核心上运行。通过设置CPU亲和性，你可I以提高Nginx的性能，因为当进程始终在同...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Nginx优化\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2020-07-05T00:00:00.000Z\\",\\"dateModified\\":\\"2025-06-05T12:14:01.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Ryan Su\\"}]}"],["meta",{"property":"og:url","content":"https://mister-hope.github.io/docs/optimization/nginx.html"}],["meta",{"property":"og:site_name","content":"Blog"}],["meta",{"property":"og:title","content":"Nginx优化"}],["meta",{"property":"og:description","content":"Nginx优化 CPU亲和 worker_cpu_affinity的指令介绍 Nginx提供了一种名为worker_cpu_affinity的指令，可以让你指定Nginxworker进程与特定CPU核心之间的亲和性，也就是把某个或某些worker进程 绑定到具体的CPU 核心上运行。通过设置CPU亲和性，你可I以提高Nginx的性能，因为当进程始终在同..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-06-05T12:14:01.000Z"}],["meta",{"property":"article:published_time","content":"2020-07-05T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-06-05T12:14:01.000Z"}]]},"git":{"createdTime":1749125641000,"updatedTime":1749125641000,"contributors":[{"name":"苏雨鸿","username":"","email":"563607356@qq.com","commits":1}]},"readingTime":{"minutes":3.88,"words":1164},"filePathRelative":"docs/optimization/nginx.md","excerpt":"\\n<h2>CPU亲和</h2>\\n<h3>worker_cpu_affinity的指令介绍</h3>\\n<p>Nginx提供了一种名为worker_cpu_affinity的指令，可以让你指定Nginxworker进程与特定CPU核心之间的亲和性，也就是把某个或某些worker进程<br>\\n绑定到具体的CPU 核心上运行。通过设置CPU亲和性，你可I以提高Nginx的性能，因为当进程始终在同一个CPU 核心上执行时，可I以利用CPU的缓存，<br>\\n从而减少内存访问延迟。<br>\\n下面是一些用法示例：</p>\\n<p>1、绑定每一个 worker进程到一个具体的 CPU 核心:</p>\\n<div class=\\"language- line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span># 示例1、如果有个4核</span></span>\\n<span class=\\"line\\"><span>worker_processes  4;</span></span>\\n<span class=\\"line\\"><span>worker_cpu_affinity 0001 0010 0100 1000; # 4个核心，就用4位bit，哪一位为1则代表用第几颗</span></span>\\n<span class=\\"line\\"><span>===</span></span>\\n<span class=\\"line\\"><span># 示例2、如果有16核</span></span>\\n<span class=\\"line\\"><span>worker_processes    16;</span></span>\\n<span class=\\"line\\"><span>worker_cpu_affinity 0000000000000001 0000000000000010 0000000000000100 0000000000001000 ...;</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{t as comp,o as data};
